<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meu Chat - Walterscheid Powertrain Group</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <body>
  <header>
    
   
    <nav>
      <div id="title"><h1>chat</h1></div>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="visualizador.html">Visualizar Pedidos</a></li>
        <li><a href="atualizar.html">Atualizar Pedidos</a></li>
        <li><a href="relatorio.html">Relatorio</a></li>
        <li><a href="chat.html">Meu Chat</a></li>
      </ul>
    </nav>
  </header>
  <main><div id="chatPedidos"></div></main>
  <footer><p>&copy; 2024 Walterscheid</p></footer>

  <!-- Chat popup button + window -->
<button id="chatBtn" title="Abrir chat">ðŸ’¬ <span class="badge" id="chatBadge"></span></button>

<div id="chatPopup" role="dialog" aria-hidden="true">
  <header>
    <h3>Chat Pedido <span id="chatPedidoId"></span></h3>
    <div>
      <button id="minimizeChat" aria-label="Minimizar">_</button>
      <button id="closeChat" aria-label="Fechar chat">&times;</button>
    </div>
  </header>
  <div class="chat-mensagens" id="chatMensagens"></div>
  <div class="chat-input">
    <textarea id="chatInput" rows="1" placeholder="Digite uma mensagem..."></textarea>
    <button id="enviarMsg">âž¤</button>
  </div>
</div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDnE2TRKu7-YQpU-H-Dr4zHuhXjxywEVVs",
      authDomain: "walterscheid-estoque.firebaseapp.com",
      projectId: "walterscheid-estoque",
      storageBucket: "walterscheid-estoque.firebasestorage.app",
      messagingSenderId: "487386736937",
      appId: "1:487386736937:web:4be50b32bb7fe90f552f38",
      measurementId: "G-9PL8JP0SD4"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    async function carregarPedidos(userEmail){
      const q = query(collection(db, "pedidos"), where("emailCriador","==",userEmail));
      const qs = await getDocs(q);
      const container = document.getElementById("chatPedidos");
      container.innerHTML = "";
      for(const docSnap of qs.docs){
        const pedido = docSnap.data();
        const div = document.createElement("div");
        div.className = "pedido-box";
        div.innerHTML = "<h3>Pedido " + pedido.idSequencial + " - " + pedido.item + "</h3><div class='chat-mensagens'><ul id='mensagens-" + pedido.idSequencial + "'></ul></div><textarea id='resposta-" + pedido.idSequencial + "' placeholder='Digite sua resposta'></textarea><br><button onclick='enviarResposta(" + pedido.idSequencial + ")'>Enviar</button> <button onclick='abrirChatPedido(" + pedido.idSequencial + ")'>Popup</button>";
        container.appendChild(div);
        carregarRespostas(pedido.idSequencial);
      }
    }

    async function carregarRespostas(pedidoId){
      const q = query(collection(db,"respostasPedidos"), where("pedidoId","==",pedidoId), orderBy("data","asc"));
      const qs = await getDocs(q);
      const lista = document.getElementById("mensagens-" + pedidoId);
      if(!lista) return;
      lista.innerHTML = "";
      qs.forEach(d=>{ const r=d.data(); const li=document.createElement("li"); const isCriador = r.autor && r.autor.includes && r.autor.includes("@"); li.classList.add("mensagem", isCriador ? "criador" : "estoque"); li.innerHTML = "<div class='bolha'>" + r.mensagem + "<small>" + r.autor + " - " + new Date(r.data).toLocaleString() + "</small></div>"; lista.appendChild(li); });
      lista.scrollTop = lista.scrollHeight;
    }

    window.enviarResposta = async (pedidoId)=>{
      const txt = document.getElementById("resposta-" + pedidoId);
      const mensagem = txt.value.trim();
      if(!mensagem) return;
      const user = auth.currentUser;
      const autor = user && user.email ? user.email : "criador";
      await addDoc(collection(db,"respostasPedidos"), { pedidoId, autor, mensagem, data: new Date().toISOString() });
      txt.value = "";
      carregarRespostas(pedidoId);
    }

    // Popup logic
    const chatBtn = document.getElementById("chatBtn");
    const chatPopup = document.getElementById("chatPopup");
    const closeChat = document.getElementById("closeChat");
    const minimizeChat = document.getElementById("minimizeChat");
    const chatMensagens = document.getElementById("chatMensagens");
    const chatInput = document.getElementById("chatInput");
    const enviarMsg = document.getElementById("enviarMsg");
    const chatBadge = document.getElementById("chatBadge");
    const chatPedidoIdSpan = document.getElementById("chatPedidoId");

    let chatPedidoAtual = null;
    let unsubscribe = null;
    let unreadCount = 0;
    let minimized = false;

    function updateBadge(){ if(unreadCount>0){ chatBadge.innerText = unreadCount; chatBadge.style.display = "inline-block"; } else { chatBadge.style.display = "none"; } }

    chatBtn.addEventListener("click", ()=>{ if(!chatPedidoAtual){ alert("Selecione um pedido (Abrir Chat) antes de usar o popup."); return;} unreadCount = 0; updateBadge(); chatPopup.style.display = "flex"; carregarChat(chatPedidoAtual); });
    closeChat.addEventListener("click", ()=>{ chatPopup.style.display = "none"; });
    minimizeChat.addEventListener("click", ()=>{ minimized = !minimized; if(minimized){ chatPopup.style.height="50px"; chatPopup.querySelector(".chat-mensagens").style.display="none"; chatPopup.querySelector(".chat-input").style.display="none"; } else { chatPopup.style.height="500px"; chatPopup.querySelector(".chat-mensagens").style.display="block"; chatPopup.querySelector(".chat-input").style.display="flex"; } });
    window.abrirChatPedido = (pedidoId)=>{ chatPedidoAtual = pedidoId; chatPedidoIdSpan.innerText = pedidoId; chatPopup.style.display = "flex"; carregarChat(pedidoId); };
    enviarMsg.addEventListener("click", async ()=>{ if(!chatPedidoAtual) return; const mensagem = chatInput.value.trim(); if(!mensagem) return; const user = auth.currentUser; const autor = user && user.email ? user.email : "criador"; await addDoc(collection(db,"respostasPedidos"), { pedidoId: chatPedidoAtual, autor, mensagem, data: new Date().toISOString() }); chatInput.value = ""; });

    function carregarChat(pedidoId){
      chatMensagens.innerHTML = "";
      if(unsubscribe) unsubscribe();
      const q = query(collection(db,"respostasPedidos"), where("pedidoId","==",pedidoId), orderBy("data","asc"));
      unsubscribe = onSnapshot(q, (snapshot)=>{
        chatMensagens.innerHTML = "";
        snapshot.forEach(docSnap=>{
          const r = docSnap.data();
          const div = document.createElement("div");
          const isCriador = r.autor && r.autor.includes && r.autor.includes("@");
          div.className = "mensagem " + (isCriador ? "criador" : "estoque");
          div.innerHTML = "<div class='bolha'>" + r.mensagem + "<small>" + r.autor + " - " + new Date(r.data).toLocaleString() + "</small></div>";
          chatMensagens.appendChild(div);
        });
        chatMensagens.scrollTop = chatMensagens.scrollHeight;
        if(chatPopup.style.display === "none"){ unreadCount++; updateBadge(); }
      });
    }

    onAuthStateChanged(auth, (user)=>{ if(user) carregarPedidos(user.email); else document.getElementById("chatPedidos").innerHTML = "<p>FaÃ§a login primeiro no Gerador.</p>"; });
  </script>
</body>
</html>
