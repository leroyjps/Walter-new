<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atualizar Pedidos - Walterscheid Powertrain Group</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <nav>
      <div id="title">
        <h1>Walterscheid Powertrain Group</h1>
      </div>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="gerador.html">Gerar Pedido</a></li>
        <li><a href="visualizador.html">Visualizar Pedidos</a></li>
        <li><a href="relatorio.html">Relatorio</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section>
      <h1>Atualizar Pedidos</h1>
      
      <div class="filtros">
        <input type="number" id="filtroId" placeholder="Filtrar por ID">
        <input type="text" id="filtroItem" placeholder="Filtrar por Item">
        <input type="text" id="filtroOp" placeholder="Filtrar por OP">
        <select id="filtroStatus">
          <option value="">Todos status</option>
          <option value="Não Liberado">Não Liberado</option>
          <option value="Liberado">Liberado</option>
          <option value="Em Produção">Em Produção</option>
          <option value="Concluído">Concluído</option>
          <option value="Falta">Falta</option>
          <option value="Pago">Pago</option>
        </select>
        <button onclick="aplicarFiltros()">Filtrar</button>
        <button onclick="limparFiltros()">Limpar</button>
      </div>

      <div class="form-atualizacao">
        <div class="form-group">
          <label for="pedidoId">ID do Pedido:</label>
          <input type="number" id="pedidoId" readonly />
        </div>
        
        <div class="form-group">
          <label for="status">Atualizar Status:</label>
          <select id="status" required>
            <option value="">Selecione um status</option>
            <option value="Liberado">Liberado</option>
            <option value="Em Produção">Em Produção</option>
            <option value="Concluído">Concluído</option>
            <option value="Falta">Falta</option>
            <option value="Pago">Pago</option>
            <option value="Não Liberado">Não Liberado</option>
          </select>
        </div>

        <div class="form-group">
          <label for="operador">Operador:</label>
          <select id="operador" required>
            <option value="">Selecione um operador</option>
            <option value="Paulo">Paulo</option>
            <option value="Jordahn">Jordahn</option>
            <option value="Junior">Junior</option>
            <option value="Carlos">Carlos</option>
            <option value="Rodrigo">Rodrigo</option>
          </select>
        </div>

        <div class="form-group">
          <label for="comentario">Comentário:</label>
          <textarea id="comentario" rows="4" placeholder="Adicione um comentário sobre o pedido" required></textarea>
        </div>

        <button id="atualizarBtn" class="btn-primary">Atualizar Status</button>
      </div>

      <h2>Pedidos Existentes</h2>
      <table id="pedidoTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Item</th>
            <th>OP</th>
            <th>Quantidade</th>
            <th>Parceiro</th>
            <th>Status</th>
            <th>Operador</th>
            <th>Data Entrada</th>
            <th>Selecionar</th>
          </tr>
        </thead>
        <tbody>
          <!-- Os pedidos serão inseridos aqui via JavaScript -->
        </tbody>
      </table>

      <div class="pagination">
        <button id="prev-btn" onclick="previousPage()">Anterior</button>
        <span id="page-info"></span>
        <button id="next-btn" onclick="nextPage()">Próxima</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-logo">
      <img src="components/images/Walterscheid.jpg" alt="Logo Walterscheid" class="logo" />
    </div>
    <p>&copy; 2024 Walterscheid. Todos os direitos reservados.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    emailjs.init("peQF3Y1KwUgr3Rt5f"); // substitua pelo seu public key do EmailJS
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getFirestore,
      collection,
      getDocs,
      updateDoc,
      doc,
      query,
      where,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDnE2TRKu7-YQpU-H-Dr4zHuhXjxywEVVs",
      authDomain: "walterscheid-estoque.firebaseapp.com",
      projectId: "walterscheid-estoque",
      storageBucket: "walterscheid-estoque.appspot.com",
      messagingSenderId: "487386736937",
      appId: "1:487386736937:web:4be50b32bb7fe90f552f38",
      measurementId: "G-9PL8JP0SD4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let pedidos = [];
    let pedidosFiltrados = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let pedidoSelecionado = null;

    async function buscarPedidos() {
      try {
        const q = query(collection(db, "pedidos"), orderBy("pedidoId", "desc"));
        const querySnapshot = await getDocs(q);
        
        pedidos = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          pedidos.push({ 
            id: doc.id,
            pedidoId: data.pedidoId,
            ...data 
          });
        });
        
        pedidosFiltrados = [...pedidos];
        atualizarTabela();
      } catch (error) {
        console.error("Erro ao buscar pedidos:", error);
        alert("Erro ao carregar pedidos. Por favor, recarregue a página.");
      }
    }

    function aplicarFiltros() {
      const filtroId = document.getElementById("filtroId").value;
      const filtroItem = document.getElementById("filtroItem").value.toLowerCase();
      const filtroOp = document.getElementById("filtroOp").value;
      const filtroStatus = document.getElementById("filtroStatus").value;

      pedidosFiltrados = pedidos.filter(pedido => {
        const matchId = !filtroId || 
                       (pedido.pedidoId && pedido.pedidoId.toString().includes(filtroId));
        const matchItem = !filtroItem || 
                        (pedido.item && pedido.item.toLowerCase().includes(filtroItem));
        const matchOp = !filtroOp || 
                       (pedido.op && pedido.op.toString().includes(filtroOp));
        const matchStatus = !filtroStatus || 
                          (pedido.status && pedido.status === filtroStatus);

        return matchId && matchItem && matchOp && matchStatus;
      });

      currentPage = 1;
      atualizarTabela();
    }

    function limparFiltros() {
      document.getElementById("filtroId").value = '';
      document.getElementById("filtroItem").value = '';
      document.getElementById("filtroOp").value = '';
      document.getElementById("filtroStatus").value = '';
      
      pedidosFiltrados = [...pedidos];
      currentPage = 1;
      atualizarTabela();
    }

    function atualizarTabela() {
      const tbody = document.querySelector("#pedidoTable tbody");
      tbody.innerHTML = "";

      const start = (currentPage - 1) * itemsPerPage;
      const pagePedidos = pedidosFiltrados.slice(start, start + itemsPerPage);

      pagePedidos.forEach((pedido) => {
        const linha = tbody.insertRow();
        
        // Formata a data para exibição
        const dataEntrada = pedido.dataEntrada ? 
          new Date(pedido.dataEntrada).toLocaleDateString('pt-BR') : 'N/A';
        
        linha.innerHTML = `
          <td>${pedido.pedidoId || 'N/A'}</td>
          <td>${pedido.item || 'N/A'}</td>
          <td>${pedido.op || 'N/A'}</td>
          <td>${pedido.quantidade || 'N/A'}</td>
          <td>${pedido.parceiro || 'N/A'}</td>
          <td class="status-${pedido.status?.replace(/\s+/g, '-').toLowerCase() || ''}">${pedido.status || 'N/A'}</td>
          <td>${pedido.operador || 'N/A'}</td>
          <td>${dataEntrada}</td>
          <td><button class="btn-selecionar" onclick="selecionarPedido('${pedido.id}')">Selecionar</button></td>
        `;
      });

      document.getElementById("page-info").innerText =
        `Página ${currentPage} de ${Math.ceil(pedidosFiltrados.length / itemsPerPage)}`;
      document.getElementById("prev-btn").disabled = currentPage === 1;
      document.getElementById("next-btn").disabled =
        (start + itemsPerPage) >= pedidosFiltrados.length;
    }

    window.selecionarPedido = async function(pedidoId) {
      try {
        const pedido = pedidos.find(p => p.id === pedidoId);
        if (!pedido) return;
        
        pedidoSelecionado = pedido;
        
        document.getElementById("pedidoId").value = pedido.pedidoId || '';
        document.getElementById("status").value = pedido.status || '';
        document.getElementById("operador").value = pedido.operador || '';
        document.getElementById("comentario").value = pedido.comentario || '';
        
        // Rola até o formulário de atualização
        document.querySelector('.form-atualizacao').scrollIntoView({
          behavior: 'smooth'
        });
      } catch (error) {
        console.error("Erro ao selecionar pedido:", error);
      }
    };

    document.getElementById("atualizarBtn").onclick = async function() {
      if (!pedidoSelecionado) {
        alert("Por favor, selecione um pedido da tabela primeiro.");
        return;
      }

      const novoStatus = document.getElementById("status").value;
      const nomeOperador = document.getElementById("operador").value;
      const comentarioNovo = document.getElementById("comentario").value;

      if (!novoStatus || !nomeOperador) {
        alert("Por favor, preencha todos os campos obrigatórios.");
        return;
      }

      try {
        const pedidoDoc = doc(db, "pedidos", pedidoSelecionado.id);
        const atualizacao = {
          status: novoStatus,
          operador: nomeOperador,
          comentario: comentarioNovo
        };

        // Atualiza data de liberação se o status for "Liberado"
        if (novoStatus === "Liberado" && pedidoSelecionado.status !== "Liberado") {
          atualizacao.dataLiberacao = new Date().toISOString();
        }

        await updateDoc(pedidoDoc, atualizacao);

        // Envia e-mail de notificação
        if (pedidoSelecionado.emailCriador) {
          emailjs.send("service_how3gpr", "template_nffl5al", {
            to_email: pedidoSelecionado.emailCriador,
            item: pedidoSelecionado.item,
            status: novoStatus,
            operador: nomeOperador,
            comentario: comentarioNovo,
            pedidoId: pedidoSelecionado.pedidoId
          }).then(() => {
            console.log("Email enviado com sucesso!");
          }).catch((error) => {
            console.error("Erro ao enviar email:", error);
          });
        }

        alert(`Pedido #${pedidoSelecionado.pedidoId} atualizado com sucesso!`);
        
        // Atualiza a lista de pedidos
        await buscarPedidos();
        
        // Limpa o formulário
        pedidoSelecionado = null;
        document.getElementById("pedidoId").value = '';
        document.getElementById("status").value = '';
        document.getElementById("operador").value = '';
        document.getElementById("comentario").value = '';
        
      } catch (error) {
        console.error("Erro ao atualizar pedido:", error);
        alert("Erro ao atualizar o pedido. Por favor, tente novamente.");
      }
    };

    window.previousPage = () => {
      if (currentPage > 1) {
        currentPage--;
        atualizarTabela();
      }
    };

    window.nextPage = () => {
      if (currentPage * itemsPerPage < pedidosFiltrados.length) {
        currentPage++;
        atualizarTabela();
      }
    };

    // Adiciona eventos para filtrar ao pressionar Enter
    document.getElementById("filtroId").addEventListener('keypress', (e) => {
      if (e.key === 'Enter') aplicarFiltros();
    });
    document.getElementById("filtroItem").addEventListener('keypress', (e) => {
      if (e.key === 'Enter') aplicarFiltros();
    });
    document.getElementById("filtroOp").addEventListener('keypress', (e) => {
      if (e.key === 'Enter') aplicarFiltros();
    });

    window.onload = buscarPedidos;
  </script>

  <style>
    .filtros {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    
    .filtros input, .filtros select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .filtros button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .filtros button:hover {
      background-color: #45a049;
    }
    
    .form-atualizacao {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .form-group textarea {
      min-height: 80px;
    }
    
    .btn-primary {
      background-color: #2196F3;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .btn-primary:hover {
      background-color: #0b7dda;
    }
    
    .btn-selecionar {
      background-color: #4CAF50;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .btn-selecionar:hover {
      background-color: #45a049;
    }
    
    /* Estilos para os status */
    .status-liberado {
      color: #2e7d32;
      font-weight: bold;
    }
    
    .status-não-liberado {
      color: #d32f2f;
      font-weight: bold;
    }
    
    .status-em-produção {
      color: #ff8f00;
      font-weight: bold;
    }
    
    .status-concluído {
      color: #1565c0;
      font-weight: bold;
    }
    
    .status-falta {
      color: #d32f2f;
      font-weight: bold;
    }
    
    .status-pago {
      color: #2e7d32;
      font-weight: bold;
    }
  </style>
</body>
</html>
