<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerar Pedidos - Walterscheid Powertrain Group</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <style>
    .highlight {
      animation: highlightAnim 2s ease;
    }
    @keyframes highlightAnim {
      0% { background-color: #d4edda; }
      100% { background-color: transparent; }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <div id="title"><h1>Walterscheid Powertrain Group</h1></div>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="visualizador.html">Visualizar Pedidos</a></li>
        <li><a href="atualizar.html">Atualizar Pedidos</a></li>
        <li><a href="relatorio.html">Relatorio</a></li>
        <li><a href="Cadastro.html">Cadastro</a></li>
        <li><a href="chat.html">Meu Chat</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section id="auth-section">
      <h2>AutenticaÃ§Ã£o</h2>
      <form id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" required />
        <input type="password" id="loginPassword" placeholder="Senha" required />
        <button type="submit">Entrar</button>
      </form>
      <button id="logoutBtn" style="display:none;">Sair</button>
      <p id="usuarioLogado"></p>
    </section>

    <section>
      <h1>Gerar Pedido</h1>
      <form id="pedidoForm">
        <input type="hidden" id="pedidoFirebaseId" />
        <label for="item">Item:</label>
        <input type="text" id="item" required />
        <label for="op">OP:</label>
        <input type="number" id="op" required />
        <label for="quantidade">Quantidade:</label>
        <input type="number" id="quantidade" required />
        <label for="parceiro">Parceiro de NegÃ³cio:</label>
        <select id="parceiro" required>
          <option value="">Selecione um parceiro</option>
          <option value="AGEMEC">AGEMEC</option>
          <option value="IMAC">IMAC</option>
          <option value="BORMIL">BORMIL</option>
          <option value="SANMAC">SANMAC</option>
          <option value="RETISUL">RETISUL</option>
          <option value="INSDUSTERM">INSDUSTERM</option>
          <option value="INDUTHERM">INDUTHERM</option>
          <option value="DUJ">DUJ</option>
          <option value="PTO">PTO</option>
          <option value="CLT">CLT</option>
          <option value="IRAPURU">IRAPURU</option>
          <option value="Index">Index</option>
        </select>
        <button type="submit" id="submitButton">Gerar Pedido</button>
        <button type="button" id="cancelarEdicao" style="display:none;">Cancelar</button>
      </form>
    </section>

    <section>
      <h2>Pedidos Gerados</h2>
      <table id="pedidoTable">
        <thead>
          <tr>
            <th>ID</th><th>Item</th><th>OP</th><th>Quantidade</th>
            <th>Parceiro</th><th>Status</th><th>Data Entrada</th><th>Ãšltima ModificaÃ§Ã£o</th><th>AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer><p>&copy; 2024 Walterscheid. Todos os direitos reservados.</p></footer>

  <!-- Chat popup button + window -->
  <button id="chatBtn" title="Abrir chat">ðŸ’¬ <span class="badge" id="chatBadge"></span></button>
  <div id="chatPopup" role="dialog" aria-hidden="true">
    <header>
      <h3>Chat Pedido <span id="chatPedidoId"></span></h3>
      <div>
        <button id="minimizeChat" aria-label="Minimizar">_</button>
        <button id="closeChat" aria-label="Fechar chat">&times;</button>
      </div>
    </header>
    <div class="chat-mensagens" id="chatMensagens"></div>
    <div class="chat-input">
      <textarea id="chatInput" rows="1" placeholder="Digite uma mensagem..."></textarea>
      <button id="enviarMsg">âž¤</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, doc, updateDoc, getDoc, setDoc, deleteDoc,
      query, orderBy, where, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDnE2TRKu7-YQpU-H-Dr4zHuhXjxywEVVs",
      authDomain: "walterscheid-estoque.firebaseapp.com",
      projectId: "walterscheid-estoque",
      storageBucket: "walterscheid-estoque.firebasestorage.app",
      messagingSenderId: "487386736937",
      appId: "1:487386736937:web:4be50b32bb7fe90f552f38",
      measurementId: "G-9PL8JP0SD4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const form = document.getElementById("pedidoForm");
    const tabela = document.querySelector("#pedidoTable tbody");
    const btnSubmit = document.getElementById("submitButton");
    const btnCancelar = document.getElementById("cancelarEdicao");

    // ===== ACRESCENTADO: Carregar parceiros do Firestore e SOMAR no select existente =====
    async function carregarParceirosDoFirestore() {
      const select = document.getElementById("parceiro");
      if (!select) return;

      // captura os nomes jÃ¡ existentes no select para evitar duplicar
      const existentes = new Set(
        [...select.options].map(o => (o.textContent || o.value || "").trim().toLowerCase())
      );

      try {
        const qParceiros = query(
          collection(db, "parceiros"),
          orderBy("nome", "asc")
          // Se quiser sÃ³ ativos, use tambÃ©m: where("ativo","==",true)
        );

        onSnapshot(qParceiros, (snap) => {
          // NÃ£o limpamos o select: apenas acrescentamos novos que nÃ£o existem
          snap.forEach(docSnap => {
            const p = docSnap.data();
            const nome = (p?.nome ?? "").trim();
            if (!nome) return;

            if (!existentes.has(nome.toLowerCase())) {
              const opt = document.createElement("option");
              // MantÃ©m compatibilidade: value = nome (seu submit usa "parceiro" = value)
              opt.value = nome;
              opt.textContent = nome;
              select.appendChild(opt);
              existentes.add(nome.toLowerCase());
            }
          });
        }, (err) => {
          console.error("Erro ao observar parceiros:", err);
        });
      } catch (e) {
        console.error("Erro ao carregar parceiros:", e);
      }
    }

    async function getNextSequentialId() {
      const counterRef = doc(db, "counters", "pedidos");
      const counterDoc = await getDoc(counterRef);
      if (counterDoc.exists()) {
        const newId = counterDoc.data().lastId + 1;
        await updateDoc(counterRef, { lastId: newId });
        return newId;
      } else {
        await setDoc(counterRef, { lastId: 1 });
        return 1;
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const item = document.getElementById("item").value;
      const op = document.getElementById("op").value;
      const quantidade = document.getElementById("quantidade").value;
      const parceiro = document.getElementById("parceiro").value;
      const user = auth.currentUser;
      if (!user) { alert("UsuÃ¡rio nÃ£o autenticado."); return; }

      const idEdicao = document.getElementById("pedidoFirebaseId").value;
      if (idEdicao) {
        await updateDoc(doc(db, "pedidos", idEdicao), {
          item, op, quantidade, parceiro,
          dataModificacao: new Date().toISOString()
        });
        alert("Pedido atualizado com sucesso!");
        btnSubmit.innerText = "Gerar Pedido";
        btnCancelar.style.display = "none";
        document.getElementById("pedidoFirebaseId").value = "";
      } else {
        const idSequencial = await getNextSequentialId();
        const pedido = { 
          idSequencial, item, op, quantidade, parceiro, 
          emailCriador: user.email, status: "NÃ£o Liberado", 
          dataEntrada: new Date().toISOString(),
          dataModificacao: new Date().toISOString()
        };
        await addDoc(collection(db, "pedidos"), pedido);
        alert("Pedido gerado com sucesso! ID: " + idSequencial);
      }

      form.reset();
      carregarPedidos();
    });

    btnCancelar.addEventListener("click", () => {
      form.reset();
      btnSubmit.innerText = "Gerar Pedido";
      btnCancelar.style.display = "none";
      document.getElementById("pedidoFirebaseId").value = "";
    });

    async function carregarPedidos() {
      const querySnapshot = await getDocs(collection(db, "pedidos"));
      let pedidos = [];
      querySnapshot.forEach((docSnap) => {
        pedidos.push({ id: docSnap.id, ...docSnap.data() });
      });

      pedidos.sort((a, b) => new Date(b.dataModificacao || b.dataEntrada) - new Date(a.dataModificacao || a.dataEntrada));
      tabela.innerHTML = "";

      pedidos.forEach((pedido) => {
        const linha = tabela.insertRow();
        linha.innerHTML = `
          <td>${pedido.idSequencial || "N/A"}</td>
          <td>${pedido.item}</td>
          <td>${pedido.op}</td>
          <td>${pedido.quantidade}</td>
          <td>${pedido.parceiro}</td>
          <td>${pedido.status}</td>
          <td>${new Date(pedido.dataEntrada).toLocaleString()}</td>
          <td>${pedido.dataModificacao ? new Date(pedido.dataModificacao).toLocaleString() : '-'}</td>
          <td>
            <button onclick="abrirChatPedido(${pedido.idSequencial})">ðŸ’¬ Chat</button>
            <button onclick='editarPedido("${pedido.id}", ${JSON.stringify(pedido).replace(/"/g, '&quot;')})'>Editar</button>
            <button onclick='excluirPedido("${pedido.id}")'>Excluir</button>
          </td>
        `;
      });
    }

    window.editarPedido = (id, pedido) => {
      document.getElementById("item").value = pedido.item;
      document.getElementById("op").value = pedido.op;
      document.getElementById("quantidade").value = pedido.quantidade;
      document.getElementById("parceiro").value = pedido.parceiro;
      document.getElementById("pedidoFirebaseId").value = id;
      btnSubmit.innerText = "Atualizar Pedido";
      btnCancelar.style.display = "inline";
    };

    window.excluirPedido = async (id) => {
      if (confirm("Tem certeza que deseja excluir este pedido?")) {
        try {
          await deleteDoc(doc(db, "pedidos", id));
          alert("Pedido excluÃ­do com sucesso!");
          carregarPedidos();
        } catch (error) {
          console.error(error);
          alert("Erro ao excluir pedido.");
        }
      }
    };

    // ===== AUTENTICAÃ‡ÃƒO =====
    document.getElementById("loginForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      signInWithEmailAndPassword(auth, email, password).catch((error) => alert("Erro: " + error.message));
    });

    document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("usuarioLogado").innerText = "Logado como: " + user.email;
        document.getElementById("logoutBtn").style.display = "inline";
        carregarPedidos();

        // ===== ACRESCENTADO: puxar parceiros do Firestore e SOMAR no select existente =====
        carregarParceirosDoFirestore();
      } else {
        document.getElementById("usuarioLogado").innerText = "NÃ£o autenticado";
      }
    });

    // ===== POPUP CHAT =====
    const chatBtn = document.getElementById("chatBtn");
    const chatPopup = document.getElementById("chatPopup");
    const closeChat = document.getElementById("closeChat");
    const minimizeChat = document.getElementById("minimizeChat");
    const chatMensagens = document.getElementById("chatMensagens");
    const chatInput = document.getElementById("chatInput");
    const enviarMsg = document.getElementById("enviarMsg");
    const chatBadge = document.getElementById("chatBadge");
    const chatPedidoIdSpan = document.getElementById("chatPedidoId");

    let chatPedidoAtual = null;
    let unsubscribe = null;
    let unreadCount = 0;
    let minimized = false;

    function updateBadge() {
      if (unreadCount > 0) { 
        chatBadge.innerText = unreadCount; 
        chatBadge.style.display = "inline-block"; 
      } else { 
        chatBadge.style.display = "none"; 
      }
    }

    chatBtn.addEventListener("click", () => {
      if (!chatPedidoAtual) { 
        alert("Selecione um pedido (Abrir Chat) antes de usar o popup."); 
        return; 
      }
      unreadCount = 0; updateBadge();
      chatPopup.style.display = "flex";
      carregarChat(chatPedidoAtual);
    });

    closeChat.addEventListener("click", () => { chatPopup.style.display = "none"; });

    minimizeChat.addEventListener("click", () => {
      minimized = !minimized;
      if (minimized) {
        chatPopup.style.height = "50px";
        chatPopup.querySelector(".chat-mensagens").style.display = "none";
        chatPopup.querySelector(".chat-input").style.display = "none";
      } else {
        chatPopup.style.height = "500px";
        chatPopup.querySelector(".chat-mensagens").style.display = "block";
        chatPopup.querySelector(".chat-input").style.display = "flex";
      }
    });

    window.abrirChatPedido = (pedidoId) => {
      chatPedidoAtual = pedidoId;
      chatPedidoIdSpan.innerText = pedidoId;
      chatPopup.style.display = "flex";
      carregarChat(pedidoId);
    };

    enviarMsg.addEventListener("click", async () => {
      if (!chatPedidoAtual) return;
      const mensagem = chatInput.value.trim();
      if (!mensagem) return;
      const user = auth.currentUser;
      const autor = user && user.email ? user.email : "criador";
      await addDoc(collection(db, "respostasPedidos"), { pedidoId: chatPedidoAtual, autor, mensagem, data: new Date().toISOString() });
      chatInput.value = "";
    });

    function carregarChat(pedidoId) {
      chatMensagens.innerHTML = "";
      if (unsubscribe) unsubscribe();
      const q = query(collection(db, "respostasPedidos"), where("pedidoId", "==", pedidoId), orderBy("data", "asc"));
      unsubscribe = onSnapshot(q, (snapshot) => {
        chatMensagens.innerHTML = "";
        snapshot.forEach(docSnap => {
          const r = docSnap.data();
          const div = document.createElement("div");
          const isCriador = r.autor && r.autor.includes && r.autor.includes("@");
          div.className = "mensagem " + (isCriador ? "criador" : "estoque");
          div.innerHTML = `<div class="bolha">${r.mensagem}<small>${r.autor} - ${new Date(r.data).toLocaleString()}</small></div>`;
          chatMensagens.appendChild(div);
        });
        chatMensagens.scrollTop = chatMensagens.scrollHeight;
        if (chatPopup.style.display === "none") { unreadCount++; updateBadge(); }
      });
    }
  </script>
</body>
</html>
