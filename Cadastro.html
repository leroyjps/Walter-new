<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Itens e Parceiros</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <!-- Excel e ZIP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #111; color: #fff; }
    h2 { margin-top: 20px; }
    form { margin-bottom: 20px; }
    input { margin: 5px; padding: 8px; border-radius: 4px; border: none; }
    button { margin: 5px; padding: 8px 15px; border: none; border-radius: 4px; background: #4CAF50; color: #fff; cursor: pointer; }
    table { width: 100%; margin-top: 10px; border-collapse: collapse; }
    th, td { border: 1px solid #444; padding: 8px; text-align: left; }
    th { background: #333; }
    tr:nth-child(even) { background: #222; }
    .logout { background: #e74c3c; float: right; }
  </style>
</head>
<body>
  <h1>Cadastro de Itens e Parceiros</h1>
  <button class="logout" onclick="logout()">Sair</button>

  <!-- Formul치rio Itens -->
  <h2>Itens</h2>
  <form id="formItens">
    <input type="text" id="nomeItem" placeholder="Nome do item" required>
    <input type="text" id="codigoItem" placeholder="C칩digo">
    <button type="submit">Cadastrar Item</button>
  </form>
  <input type="file" id="fileItens" accept=".xlsx, .xls">
  <button onclick="exportar('itens')">Exportar Itens</button>
  <table id="tabelaItens">
    <thead><tr><th>Nome</th><th>C칩digo</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- Formul치rio Parceiros -->
  <h2>Parceiros</h2>
  <form id="formParceiros">
    <input type="text" id="nomeParceiro" placeholder="Nome do parceiro" required>
    <input type="text" id="codigoParceiro" placeholder="C칩digo">
    <button type="submit">Cadastrar Parceiro</button>
  </form>
  <input type="file" id="fileParceiros" accept=".xlsx, .xls">
  <button onclick="exportar('parceiros')">Exportar Parceiros</button>
  <table id="tabelaParceiros">
    <thead><tr><th>Nome</th><th>C칩digo</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- Exportar Tudo -->
  <h2>Exporta칞칚o Geral</h2>
  <button onclick="exportarTudo()">Exportar Tudo (ZIP)</button>

  <script>
    // =========================
    // Configura칞칚o Firebase
    // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyDnE2TRKu7-YQpU-H-Dr4zHuhXjxywEVVs",
    authDomain: "walterscheid-estoque.firebaseapp.com",
    databaseURL: "https://walterscheid-estoque-default-rtdb.firebaseio.com",
    projectId: "walterscheid-estoque",
    storageBucket: "walterscheid-estoque.appspot.com",
    messagingSenderId: "487386736937",
    appId: "1:487386736937:web:4be50b32bb7fe90f552f38",
    measurementId: "G-9PL8JP0SD4"
  };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // 游댏 S칩 permite usu치rio logado
    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = "login.html";
    });

    function logout() {
      auth.signOut();
    }

    // =========================
    // Fun칞칚o de cadastro 칰nico
    // =========================
    async function cadastrarUnico(collection, dados) {
      // Checa duplicado por nome
      const snapNome = await db.ref(collection).orderByChild("nome").equalTo(dados.nome).once("value");
      if (snapNome.exists()) {
        alert(`J치 existe em ${collection}: "${dados.nome}"`);
        return false;
      }

      // Checa duplicado por c칩digo
      if (dados.codigo) {
        const snapCodigo = await db.ref(collection).orderByChild("codigo").equalTo(dados.codigo).once("value");
        if (snapCodigo.exists()) {
          alert(`J치 existe em ${collection} com c칩digo "${dados.codigo}"`);
          return false;
        }
      }

      await db.ref(collection).push(dados);
      return true;
    }

    // =========================
    // Cadastro manual
    // =========================
    document.getElementById("formItens").addEventListener("submit", async e => {
      e.preventDefault();
      const nome = document.getElementById("nomeItem").value.trim();
      const codigo = document.getElementById("codigoItem").value.trim();
      const sucesso = await cadastrarUnico("itens", { nome, codigo });
      if (sucesso) e.target.reset();
    });

    document.getElementById("formParceiros").addEventListener("submit", async e => {
      e.preventDefault();
      const nome = document.getElementById("nomeParceiro").value.trim();
      const codigo = document.getElementById("codigoParceiro").value.trim();
      const sucesso = await cadastrarUnico("parceiros", { nome, codigo });
      if (sucesso) e.target.reset();
    });

    // =========================
    // Listagem em tempo real
    // =========================
    function listar(collection, tabelaId) {
      db.ref(collection).on("value", snapshot => {
        const tbody = document.querySelector(`#${tabelaId} tbody`);
        tbody.innerHTML = "";
        snapshot.forEach(child => {
          const { nome, codigo } = child.val();
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${nome}</td><td>${codigo || ""}</td>`;
          tbody.appendChild(tr);
        });
      });
    }
    listar("itens", "tabelaItens");
    listar("parceiros", "tabelaParceiros");

    // =========================
    // Importa칞칚o via Excel
    // =========================
    function importarExcel(fileInput, collection) {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);

        for (const row of rows) {
          if (row.nome) {
            await cadastrarUnico(collection, {
              nome: row.nome,
              codigo: row.codigo || ""
            });
          }
        }
        alert("Importa칞칚o conclu칤da!");
      };
      reader.readAsArrayBuffer(file);
    }

    document.getElementById("fileItens").addEventListener("change", e => importarExcel(e.target, "itens"));
    document.getElementById("fileParceiros").addEventListener("change", e => importarExcel(e.target, "parceiros"));

    // =========================
    // Exporta칞칚o separada
    // =========================
    async function exportar(collection) {
      const snapshot = await db.ref(collection).once("value");
      const dados = [];
      snapshot.forEach(child => dados.push(child.val()));
      if (dados.length === 0) return alert("Nenhum dado para exportar.");

      const ws = XLSX.utils.json_to_sheet(dados);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, collection);
      XLSX.writeFile(wb, `${collection}.xlsx`);
    }

    // =========================
    // Exporta칞칚o ZIP
    // =========================
    async function exportarTudo() {
      const zip = new JSZip();
      const colecoes = ["itens", "parceiros"];

      for (const col of colecoes) {
        const snapshot = await db.ref(col).once("value");
        const dados = [];
        snapshot.forEach(child => dados.push(child.val()));

        if (dados.length > 0) {
          const ws = XLSX.utils.json_to_sheet(dados);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, col);
          const buffer = XLSX.write(wb, { bookType: "xlsx", type: "array" });
          zip.file(`${col}.xlsx`, buffer);
        }
      }

      zip.generateAsync({ type: "blob" }).then(content => {
        saveAs(content, "exportacao.zip");
      });
    }
  </script>
</body>
</html>