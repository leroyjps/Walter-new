<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visualizar Pedidos - Walterscheid Powertrain Group</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <nav>
      <div id="title">
        <h1>Walterscheid Powertrain Group</h1>
      </div>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="gerador.html">Gerar Pedido</a></li>
        <li><a href="atualizar.html">Atualizar Pedidos</a></li>
        <li><a href="Relatorio.html">Relatorio</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="visualizador-section">
      <h1>Visualizar Pedidos</h1>
      
      <div class="filtros">
        <input type="text" id="filtroId" placeholder="Filtrar por ID">
        <input type="text" id="filtroItem" placeholder="Filtrar por Item">
        <input type="text" id="filtroOp" placeholder="Filtrar por OP">
        <select id="filtroStatus">
          <option value="">Todos status</option>
          <option value="Não Liberado">Não Liberado</option>
          <option value="Liberado">Liberado</option>
          <option value="Em Produção">Em Produção</option>
          <option value="Concluído">Concluído</option>
        </select>
        <button onclick="aplicarFiltros()">Filtrar</button>
        <button onclick="limparFiltros()">Limpar</button>
      </div>
      
      <table id="pedidoTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Item</th>
            <th>OP</th>
            <th>Quantidade</th>
            <th>Parceiro</th>
            <th>Status</th>
            <th>Data de Entrada</th>
            <th>Operador</th>
          </tr>
        </thead>
        <tbody>
          <!-- Pedidos carregados via JS -->
        </tbody>
      </table>

      <div class="pagination">
        <button id="prev-btn" onclick="previousPage()">Anterior</button>
        <span id="page-info"></span>
        <button id="next-btn" onclick="nextPage()">Próxima</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-logo">
      <img src="components/images/Walterscheid.jpg" alt="Logo Walterscheid" class="logo" />
    </div>
    <p>&copy; 2024 Walterscheid. Todos os direitos reservados.</p>
  </footer>

  <!-- Som de notificação -->
  <audio id="notificacaoAudio" src="components/audio/alerta.mp3" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      orderBy,
      where
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDnE2TRKu7-YQpU-H-Dr4zHuhXjxywEVVs",
      authDomain: "walterscheid-estoque.firebaseapp.com",
      projectId: "walterscheid-estoque",
      storageBucket: "walterscheid-estoque.appspot.com",
      messagingSenderId: "487386736937",
      appId: "1:487386736937:web:4be50b32bb7fe90f552f38",
      measurementId: "G-9PL8JP0SD4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let pedidos = [];
    let pedidosFiltrados = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let ultimoPedidoId = null;
    let pedidoDestaqueId = null;
    let filtrosAtivos = false;

    async function fetchPedidos() {
      let q;
      if (filtrosAtivos) {
        // Se há filtros ativos, não precisamos buscar novamente
        return;
      } else {
        q = query(collection(db, "pedidos"), orderBy("pedidoId", "desc"));
      }
      
      const querySnapshot = await getDocs(q);
      const novosPedidos = [];

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        novosPedidos.push({ 
          id: doc.id, 
          pedidoId: data.pedidoId || 'N/A',
          ...data 
        });
      });

      // Detecta novo pedido
      if (pedidos.length > 0 && novosPedidos.length > 0 && 
          (novosPedidos[0].pedidoId !== pedidos[0].pedidoId || novosPedidos.length > pedidos.length)) {
        pedidoDestaqueId = novosPedidos[0].id;
        document.getElementById("notificacaoAudio").play();
        setTimeout(() => {
          pedidoDestaqueId = null;
          renderPedidos();
        }, 6000); // Remove destaque após 6 segundos
      }

      pedidos = novosPedidos;
      if (!filtrosAtivos) {
        pedidosFiltrados = [...pedidos];
      }
      renderPedidos();
    }

    function aplicarFiltros() {
      const filtroId = document.getElementById("filtroId").value.toLowerCase();
      const filtroItem = document.getElementById("filtroItem").value.toLowerCase();
      const filtroOp = document.getElementById("filtroOp").value.toLowerCase();
      const filtroStatus = document.getElementById("filtroStatus").value;

      pedidosFiltrados = pedidos.filter(pedido => {
        const matchId = filtroId === '' || 
                        (pedido.pedidoId && pedido.pedidoId.toString().includes(filtroId));
        const matchItem = filtroItem === '' || 
                         (pedido.item && pedido.item.toLowerCase().includes(filtroItem));
        const matchOp = filtroOp === '' || 
                       (pedido.op && pedido.op.toString().includes(filtroOp));
        const matchStatus = filtroStatus === '' || 
                           (pedido.status && pedido.status === filtroStatus);

        return matchId && matchItem && matchOp && matchStatus;
      });

      filtrosAtivos = filtroId !== '' || filtroItem !== '' || filtroOp !== '' || filtroStatus !== '';
      currentPage = 1;
      renderPedidos();
    }

    function limparFiltros() {
      document.getElementById("filtroId").value = '';
      document.getElementById("filtroItem").value = '';
      document.getElementById("filtroOp").value = '';
      document.getElementById("filtroStatus").value = '';
      
      pedidosFiltrados = [...pedidos];
      filtrosAtivos = false;
      currentPage = 1;
      renderPedidos();
    }

    function renderPedidos() {
      const tabela = document.querySelector("#pedidoTable tbody");
      tabela.innerHTML = "";

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pagePedidos = pedidosFiltrados.slice(start, end);

      pagePedidos.forEach((pedido) => {
        const linha = tabela.insertRow();
        if (pedido.id === pedidoDestaqueId) {
          linha.style.backgroundColor = "#fff3cd";
          linha.style.fontWeight = "bold";
          linha.classList.add("destaque-pedido");
        }
        
        // Formata a data para exibição
        const dataEntrada = pedido.dataEntrada ? 
          new Date(pedido.dataEntrada).toLocaleString('pt-BR') : 'N/A';
        
        linha.innerHTML = `
          <td>${pedido.pedidoId || 'N/A'}</td>
          <td>${pedido.item || 'N/A'}</td>
          <td>${pedido.op || 'N/A'}</td>
          <td>${pedido.quantidade || 'N/A'}</td>
          <td>${pedido.parceiro || 'N/A'}</td>
          <td>${pedido.status || 'N/A'}</td>
          <td>${dataEntrada}</td>
          <td>${pedido.operador || 'N/A'}</td>
        `;
      });

      document.getElementById("page-info").innerText =
        `Página ${currentPage} de ${Math.ceil(pedidosFiltrados.length / itemsPerPage)}`;
      document.getElementById("prev-btn").disabled = currentPage === 1;
      document.getElementById("next-btn").disabled = end >= pedidosFiltrados.length;
    }

    window.previousPage = () => {
      if (currentPage > 1) {
        currentPage--;
        renderPedidos();
      }
    };

    window.nextPage = () => {
      if (currentPage * itemsPerPage < pedidosFiltrados.length) {
        currentPage++;
        renderPedidos();
      }
    };

    window.onload = () => {
      fetchPedidos();
      setInterval(fetchPedidos, 10000); // Atualiza a cada 10s
      
      // Adiciona eventos para filtrar ao pressionar Enter
      document.getElementById("filtroId").addEventListener('keypress', (e) => {
        if (e.key === 'Enter') aplicarFiltros();
      });
      document.getElementById("filtroItem").addEventListener('keypress', (e) => {
        if (e.key === 'Enter') aplicarFiltros();
      });
      document.getElementById("filtroOp").addEventListener('keypress', (e) => {
        if (e.key === 'Enter') aplicarFiltros();
      });
    };
  </script>

  <style>
    .destaque-pedido {
      animation: piscar 1s ease-in-out infinite;
    }

    @keyframes piscar {
      0%, 100% { background-color: #fff3cd; }
      50% { background-color: #ffeeba; }
    }
    
    .filtros {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    
    .filtros input, .filtros select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .filtros button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .filtros button:hover {
      background-color: #45a049;
    }
  </style>
</body>
</html>
